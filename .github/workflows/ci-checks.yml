name: Continuous Integration Checks

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: HTML Validation
        run: |
          echo "üîç Validating HTML files..."
          HTML_FILES=$(find . -name "*.html" -not -path "./node_modules/*")
          for file in $HTML_FILES; do
            echo "Checking $file..."
            # Check for basic HTML structure
            if grep -q "<!DOCTYPE html>" "$file" && \
               grep -q "<html" "$file" && \
               grep -q "</html>" "$file" && \
               grep -q "<head>" "$file" && \
               grep -q "</head>" "$file" && \
               grep -q "<body>" "$file" && \
               grep -q "</body>" "$file"; then
              echo "‚úì $file has valid HTML structure"
            else
              echo "‚úó $file may have HTML structure issues"
              exit 1
            fi
          done
          echo "‚úÖ All HTML files validated"

      - name: JavaScript Syntax Check
        run: |
          echo "üîç Checking JavaScript syntax..."
          if [ -f "app.js" ]; then
            node -c app.js
            echo "‚úì app.js syntax is valid"
          fi
          echo "‚úÖ JavaScript validation complete"

      - name: CSS Basic Check
        run: |
          echo "üîç Checking CSS files..."
          CSS_FILES=$(find . -name "*.css" -not -path "./node_modules/*")
          for file in $CSS_FILES; do
            echo "Checking $file..."
            # Basic CSS validation - check for balanced braces
            OPEN=$(grep -o "{" "$file" | wc -l)
            CLOSE=$(grep -o "}" "$file" | wc -l)
            if [ "$OPEN" -eq "$CLOSE" ]; then
              echo "‚úì $file has balanced braces"
            else
              echo "‚úó $file has unbalanced braces ($OPEN open, $CLOSE close)"
              exit 1
            fi
          done
          echo "‚úÖ CSS validation complete"

      - name: File Structure Check
        run: |
          echo "üîç Checking project structure..."
          REQUIRED_FILES=(
            "css.html"
            "c.css"
            "app.js"
            "README.md"
            ".github/workflows/static.yml"
            ".github/workflows/auto-merge.yml"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úì $file exists"
            else
              echo "‚úó Missing required file: $file"
              exit 1
            fi
          done
          echo "‚úÖ Project structure validated"

      - name: Check for Security Issues
        run: |
          echo "üîç Checking for common security issues..."

          # Check for inline event handlers (potential XSS)
          if grep -r "onclick\|onerror\|onload" --include="*.html" .; then
            echo "‚ö†Ô∏è Warning: Found inline event handlers. Consider using addEventListener instead."
          fi

          # Check for eval usage
          if grep -r "eval(" --include="*.js" .; then
            echo "‚ùå Error: Found eval() usage which can be a security risk"
            exit 1
          fi

          echo "‚úÖ Security check complete"

      - name: Code Size Report
        run: |
          echo "üìä Code Statistics:"
          echo "HTML: $(find . -name "*.html" -not -path "./node_modules/*" -exec cat {} \; | wc -l) lines"
          echo "CSS: $(find . -name "*.css" -not -path "./node_modules/*" -exec cat {} \; | wc -l) lines"
          echo "JavaScript: $(find . -name "*.js" -not -path "./node_modules/*" -exec cat {} \; | wc -l) lines"
          echo "Total project size: $(du -sh . | cut -f1)"

  link-checker:
    name: Check Links and Resources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check resource paths
        run: |
          echo "üîç Checking resource paths..."

          # Check CSS links
          if grep -q 'href="./c.css"' css.html; then
            echo "‚úì CSS link is correctly formatted"
          else
            echo "‚úó CSS link may be incorrect"
            exit 1
          fi

          # Check JS script
          if grep -q 'src="./app.js"' css.html; then
            echo "‚úì JavaScript link is correctly formatted"
          else
            echo "‚úó JavaScript link may be incorrect"
            exit 1
          fi

          echo "‚úÖ Resource paths validated"

  summary:
    name: Build Summary
    needs: [code-quality, link-checker]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          if [ "${{ needs.code-quality.result }}" == "success" ] && [ "${{ needs.link-checker.result }}" == "success" ]; then
            echo "::notice::‚úÖ All CI checks passed! Code is ready for deployment."
          else
            echo "::error::‚ùå Some CI checks failed. Please review the errors above."
            exit 1
          fi
